name: Terraform CD - Prod

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions:
  contents: read
  id-token: write
  pull-requests: write

jobs:
  check_branch:
    name: Check branch
    runs-on: ubuntu-latest
    steps:
      - name: Check if only merging dev -> main
        if: github.base_ref == 'main' && github.head_ref != 'dev'
        run: |
          echo "ERROR: You can only merge to main from dev."
          exit 1

  plan-prod:
    # This job calls the Reusable Terraform Plan workflow from your repo
    name: Plan for Prod
    needs: [check_branch]
    uses: Azure-CICD-Labs/Branch-Based-Reusable-Workflows/.github/workflows/tf-plan.yml@main
    with:
      environment_name: prod-plan
      plan_filename: prod.tfplan
      artifact_name: terraform-prod-plan
      container_name: ${{ vars.TFSTATE_CONTAINER_NAME }}
      tfstate_key: branch-based.tfstate
      # For pull_request, use the PR head SHA; for push, use github.sha
      checkout_ref: ${{ github.event.pull_request.head.sha || github.sha }}
      is_pr: ${{ github.event_name == 'pull_request' }}

  apply-prod:
    # This job calls the Reusable Terraform Apply workflow
    name: Apply to Prod
    needs: [plan-prod]
    uses: Azure-CICD-Labs/Branch-Based-Reusable-Workflows/.github/workflows/tf-apply.yml@main

    # Only run if push event + Plan had exitcode==2
    if: >
      github.event_name == 'push' &&
      needs.plan-prod.outputs.tfplan_exitcode == '2'

    with:
      environment_name: prod-apply
      plan_filename: prod.tfplan
      artifact_name: terraform-prod-plan
      container_name: ${{ vars.TFSTATE_CONTAINER_NAME }}
      tfstate_key: branch-based.tfstate
      checkout_ref: ${{ github.sha }}